<!-- <!DOCTYPE html> -->
<html>
	<head>
		<style type='text/css'>

			@media (min-width:800px){
				#color_buttons {
					margin-left: 13.5%;
				}
			}

			@media (max-width:799px){
        #color_buttons {
					margin-left: 22.5%;
        }
	      div.tooltip {
					display: none;
	      }
	    }

			#hidden_button_win,
			#hidden_button_lose {
				display: none;
			}

		</style>
		<script type='text/javascript'>

			boolDic = { true: 1, false: 0 },
			pieceDic = {
				0: {
						'piece': '',
						'number_text': 'Zero',
						'font_size': 0
					},
				1: {
						'piece': '.',
						'number_text': 'One',
						'font_size': 25
					},
				2: {
						'piece': ':',
						'number_text': 'Two',
						'font_size': 25
					},
				3: {
						'piece': ':.',
						'number_text': 'Three',
						'font_size': 25
					},
				4: {
						'piece': '::',
						'number_text': 'Four',
						'font_size': 25
					},
				5: {
						'piece': 'â˜…',
						'number_text': 'Five',
						'font_size': 12.5
					}
			},
			levelAddress = window.location.href,
			level = levelAddress.charAt(levelAddress.length-2);

			gameSettings = {
				1: {
						'code_length': 4,
						'code_length_text': 'four',
						'color_options': Array('yellow', 'blue', 'red', 'green', 'orange', 'purple'),
						'color_buttons_data': Array(1, 2, 3, 4, 5, 6),
						'max_turns': 8,
						'max_clicks': 32,
						'rect_text_loc': Array(17.5, 23.5),
						'code_reveal_left_margin': 12.5,
						'code_reveal_right_margin': 123,
						'button_spacer': 3,
						'game_board_height': 354
					 },
				2: {
						'code_length': 4,
						'code_length_text': 'four',
						'color_options': Array('yellow', 'blue', 'red', 'green', 'orange', 'purple', 'brown', 'pink'),
						'color_buttons_data': Array(1, 2, 3, 4, 5, 6, 7, 8),
						'max_turns': 9,
						'max_clicks': 36,
						'rect_text_loc': Array(17.5, 23.5),
						'code_reveal_left_margin': 12.5,
						'code_reveal_right_margin': 123,
						'button_spacer': 2,
						'game_board_height': 390.5
					 },
				3: {
						'code_length': 5,
						'code_length_text': 'five',
						'color_options': Array('yellow', 'blue', 'red', 'green', 'orange', 'purple'),
						'color_buttons_data': Array(1, 2, 3, 4, 5, 6),
						'max_turns': 9,
						'max_clicks': 45,
						'rect_text_loc': Array(14, 23.5),
						'code_reveal_left_margin': 12.5,
						'code_reveal_right_margin': 108,
						'button_spacer': 3,
						'game_board_height': 390.5
					 },
				4: {
						'code_length': 5,
						'code_length_text': 'five',
						'color_options': Array('yellow', 'blue', 'red', 'green', 'orange', 'purple', 'brown', 'pink'),
						'color_buttons_data': Array(1, 2, 3, 4, 5, 6, 7, 8),
						'max_turns': 10,
						'max_clicks': 50,
						'rect_text_loc': Array(14, 23.5),
						'code_reveal_left_margin': 12.5,
						'code_reveal_right_margin': 108,
						'button_spacer': 2,
						'game_board_height': 427
					 }
			};

			colorCode = [];
			for ( i=1; i < gameSettings[level]['code_length']+1; i++ ) {
				window['color' + i] = gameSettings[level]['color_options'][getRandomInt(0, gameSettings[level]['color_options'].length)];
			  colorCode.push(window['color' + i])
			};
			console.log(colorCode);

		</script>
	</head>
	<body>
		<div class='no_selection no_events' id='level_message' align='center'></div>
		<script type='text/javascript'>

			document.getElementById('level_message').innerHTML = String(gameSettings[level]['max_turns']) + ' tries to crack the ' + colorCode.length + ' color code.<br>' + String(gameSettings[level]['color_options'].length) + ' possible colors.'

		</script>
		<!-- Load color palettes -->
		<script src='https://d3js.org/d3-scale-chromatic.v1.min.js'></script>
		<!-- Create a div where the graph will take place -->
		<div class='no_selection' id='game_board' align='center' style='margin-top:20px;'></div>
		<div class='no_selection' id='hidden_button_win'>
			<div id='hidden_button_win_text'>
				<span class='blinking_text'>
					<p align='center' style='margin-left:-3.5px; margin-top:-20px; margin-bottom:5px;'>
						<font size='5.5'>
							<b>You win!</b>
						</font>
					</p>
				</span>
			</div>
			<div class='center'>
				<a href='{{ site.url }}/mastermind/play/' class='btn-group'>Play Again</a>
				<br><br><br>
			</div>
		</div>
		<div class='no_selection' id='hidden_button_lose'>
			<div class='no_selection no_events' id='color_code_reveal' align='center'></div>
			<div id='hidden_button_lose_text'>
				<span class='blinking_text'>
					<p align='center' style='margin-left:-187.5px; margin-top:-220px;'>
						<font size='5.5'>
							<b>You lose!</b>
						</font>
					</p>
				</span>
				<p align='center' style='margin-left:-177.5px; margin-top:-30px; margin-bottom:70px;'>Here's the code:</p>
			</div>
			<div class='center'>
				<a href='{{ site.url }}/mastermind/play/' class='btn-group' style='margin-top:20px;'>Play Again</a>
				<br><br><br>
			</div>
		</div>
		<!-- Create a div where the color selection will take place -->
		<div id='color_buttons' align='center' style='margin-top:-40px; margin-bottom:-60px;'></div>
		<script type='text/javascript'>

			// Define colors for both svg1 and svg2
			colorDic = {
				'rgb(152, 78, 163)': 'purple',
				'rgb(77, 175, 74)': 'green',
				'rgb(55, 126, 184)': 'blue',
				'rgb(228, 26, 28)': 'red',
				'rgb(255, 255, 51)': 'yellow',
				'rgb(255, 127, 0)': 'orange',
				'rgb(166, 86, 40)': 'brown',
				'rgb(247, 129, 191)': 'pink',
				'purple': 'rgb(152, 78, 163)',
				'green': 'rgb(77, 175, 74)',
				'blue': 'rgb(55, 126, 184)',
				'red': 'rgb(228, 26, 28)',
				'yellow': 'rgb(255, 255, 51)',
				'orange': 'rgb(255, 127, 0)',
				'brown': 'rgb(166, 86, 40)',
				'pink': 'rgb(247, 129, 191)'
			};

			// set the dimensions and margins of the svg1 graph
			margin = {
				'top': 30,
				'right': 25,
				'bottom': 30,
				'left': 25
			},
			width = 345,
			height = gameSettings[level]['game_board_height'];

			// Define global variables for svg1
			clickCount = 0;
			gameScores = {
				'W': [],
				'B': []
			},
			currentTurn = 1,
			gameGuesses = [];

			// Define global variables for svg2
			colorScale = d3.scaleOrdinal(d3['schemeSet1']),
			circ_radius = 100,
			svg2Size = circ_radius * 3,
			interval = 360/gameSettings[level]['color_options'].length;

			// append the svg objects to the body of the page
			appendGroupSVG('svg1', 'game_board', width, height, margin.left, margin.top, 'auto');
			appendGroupSVG('svg2', 'color_buttons', svg2Size, svg2Size, circ_radius, circ_radius, 'auto');
			defineTooltip('game_board', 'game_board_tooltip', '555px', 0, '122.5px', '52.5px', 0, '')

			d3.csv('/assets/csv/mastermind/game_board_' + String(level) + '.csv', function(data) {
				// Build X and Y scales and axis:
				x = d3.scaleBand()
							.range([0, width - margin.left - margin.right])
							.domain(d3.map(data, function(d){ return d.column; }).keys())
							.padding(0.05),
				y = d3.scaleBand()
							.range([0, height - margin.top - margin.bottom])
							.domain(d3.map(data, function(d){ return d.turn; }).keys())
							.padding(0.05);

				callGroupSVG(svg1, null, null, 14.5, null, d3.axisTop(x).tickSize(0), 'none');
				callGroupSVG(svg1, null, null, 14.5, null, d3.axisLeft(y).tickSize(0), 'none');
				svg1.selectAll('.domain').remove();

				// Three function that change the tooltip when user hover / move / leave a cell
 				var rectMouseover = function(d) {

 						if ( (d.column=='W' || d.column=='B') && getBodyDimenstions()[0]>=800 ) {

							if ( clickCount < d.turn*colorCode.length )
							{ d3.select('#game_board_tooltip').html('This round hasn\'t<br>been played yet.'); }
							else {
								tooltipNumber = pieceDic[gameScores[d.column][d.turn-1]]['number_text'];
								if ( d.column=='W' )
								{ colorState = ' wrong'; }
								else
								{ colorState = ' right'; }

								if ( tooltipNumber=='One' )
								{ d3.select('#game_board_tooltip').html(tooltipNumber + ' right color<br>in the ' + colorState + ' place.'); }
								else
								{ d3.select('#game_board_tooltip').html(tooltipNumber + ' right colors<br>in the ' + colorState + ' place.'); }
							}

							d3.select(this).style('stroke-width', 4).style('cursor', 'help');
 							d3.select('#game_board_tooltip').style('opacity', 1).style('top', (d3.mouse(this)[1]) + 76.5 + 'px');
 					 	}
 			 	},
 						rectMouseleave = function(d) {
 						if ( d.column=='W' || d.column=='B' ) {
 								d3.select('#game_board_tooltip').style('opacity', 0);
 								d3.select(this)
 									.style('stroke-width', 1)
 									.style('stroke', 'black')
 									.style('opacity', 1);
 						}
 				};

			  rect = svg1.selectAll()
				    .data(data, function(d) { return d.column+':'+d.turn; })
				    .enter();

				rect.append('rect')
						.attr('class', 'rects')
						.attr('x', function(d) { return x(d.column); })
			      .attr('y', function(d) { return y(d.turn); })
			      .attr('rx', 3)
			      .attr('ry', 3)
			      .attr('width', x.bandwidth())
			      .attr('height', y.bandwidth())
			      .style('fill', function(d) {
							if ( d.column=='W' || d.column=='B' )
							{ return 'rgb(211,211,211)'; }
							else
							{ return '#ffffff'; }
						})
						.style('stroke', 'black')
						.attr('stroke-width', 1)
				    .on('mouseover', rectMouseover)
				    .on('mouseleave', rectMouseleave);

				var buttonMouseover = function(d) {

						d3.select(this)
							.style('stroke-width', 4)
							.style('cursor', 'pointer');
 				},
 						buttonMouseleave = function(d) {

						d3.select(this).style('stroke-width', 2);
 				};

				svg2.selectAll('circle')
			    .data(gameSettings[level]['color_buttons_data'])
			    .enter()
					.append('circle')
					.attr('id', 'color_buttons')
			    .attr('fill', function(d, i ) { return colorScale(d); })
			    .attr('r', (svg2Size*gameSettings[level]['button_spacer'])/interval)
			    .attr('transform', function (d, i) {
			        return 'translate(' + ((svg2Size/2-circ_radius) * Math.cos((interval*i)
							* Math.PI/180)) + ',' + ((svg2Size/2-circ_radius) * Math.sin((interval*i)
							* Math.PI/180)) + ')'
						})
					.style('stroke-width', 2)
					.style('stroke', 'black')
			    .on('mouseover', buttonMouseover)
			    .on('mouseleave', buttonMouseleave)
					.on('click', function() {
		          clickCount+=1;
							rgbColorGuess = d3.select(this).style('fill');
							gameGuesses.push(colorDic[rgbColorGuess]);
							updateGameBoardColors(rgbColorGuess);
							if ( clickCount>=colorCode.length && clickCount%colorCode.length==0 )
							{ scorePreviousRound(); }
							else if ( clickCount>=colorCode.length && clickCount%colorCode.length==1 && currentTurn!=gameSettings[level]['max_turns'] )
							{ currentTurn+=1; }
						});

				appendText(svg2, 'cursive', null, -21.5, -5, '17px', 'normal', 1, 0.5, 'Choose');
				appendText(svg2, 'cursive', null, -23, 16.5, '17px', 'normal', 1, 0.5, 'a Color');

				function updateGameBoardColors(rgbColorGuess) {

					svg1.selectAll('.rects').filter(function(d) { return d.color_index==clickCount; }).style('fill', rgbColorGuess);
					svg1.selectAll('.rects')
						.style('stroke-width', function(d) {
							if ( d.color_index==clickCount+1 )
							{ return 4; }
							else
							{ return 1; }
						});
				};

				function countBGuesses(previousTurnGuesses) {

					nonBGuesses = [],
					bCount = 0;
					for ( i=0; i < colorCode.length; i++ ) {
						if ( previousTurnGuesses[i]==colorCode[i] ) {
							nonBGuesses.push(null);
							bCount+=1;
						}
						else
						{ nonBGuesses.push(previousTurnGuesses[i]); }
					}
					return [bCount, nonBGuesses];
				};

				function countWGuesses(nonBGuesses) {

					// creating new array colorCodeCopy because deletions will be made and original array cannot be affected.
					colorCodeCopy = [];
					for ( i=1; i < colorCode.length+1; i++ ) {
						colorCodeCopy.push(window['color' + i]);
					}

					// removing all correct guesses for the previous turn from colorCodeCopy.
					for ( i=0; i < colorCode.length; i++ ) {
						if ( nonBGuesses[i]==null )
						{ delete colorCodeCopy[i]; }
					}

					// counting total w pieces by comparing remaining guesses to remaining color code.
					wCount = 0;
					for ( i=0; i < colorCode.length; i++ ) {
						if ( nonBGuesses[i]!=null && colorCodeCopy.includes(nonBGuesses[i]) ) {
							delete colorCodeCopy[colorCodeCopy.indexOf(nonBGuesses[i])];
						 	wCount+=1;
					 	}
					}
					return wCount;
				};

				function scorePreviousRound() {

					previousTurnGuesses = gameGuesses.slice(Math.max(gameGuesses.length-colorCode.length, 0));
					bGuessesAssessment = countBGuesses(previousTurnGuesses);
					nonBGuesses = bGuessesAssessment[1];
					gameScores['B'].push(bGuessesAssessment[0]);
					gameScores['W'].push(countWGuesses(nonBGuesses));

					rect.append('text')
							.filter(function(d) { return ( d.column=='W' || d.column=='B' ) && d.turn==currentTurn; })
						.attr('id', 'rect_text')
						.attr('x', function(d) { return x(d.column) + gameSettings[level]['rect_text_loc'][0] })
						.attr('y', function(d) { if ( pieceDic[gameScores[d.column][currentTurn-1]]['piece']=='â˜…' )
																		 { return y(d.turn) + gameSettings[level]['rect_text_loc'][1] - 2; }
																		 else
																		 { return y(d.turn) + gameSettings[level]['rect_text_loc'][1]; }})
						.style('font-size', function(d) { return pieceDic[gameScores[d.column][currentTurn-1]]['font_size']; })
						.style('stroke-width', 1.5)
						.style('stroke', 'black')
						.text(function(d) { return pieceDic[gameScores[d.column][currentTurn-1]]['piece']; });

					// conditions for a winning game below.
					if ( gameScores['B'][gameScores['B'].length-1]==colorCode.length ) {
						document.getElementById('color_buttons').style.display = 'none';
						document.getElementById('hidden_button_win').style.display = 'block';
						svg1.selectAll('.rects').style('stroke-width', 1);
						svg1.selectAll('.rects').filter(function(d) { return d.turn==currentTurn && d.column!='W' && d.column!='B'; }).style('stroke-width', 4);
						launchFireworkShow(5, 5, 2500);
					}
					// conditions for a losing game below.
					else if ( gameScores['B'][gameScores['B'].length-1]!=colorCode.length && clickCount==gameSettings[level]['max_clicks'] ) {

						document.getElementById('color_buttons').style.display = 'none';
						document.getElementById('hidden_button_lose').style.display = 'block';

						// set the dimensions and margins of the graph
						margin = {
							'top': 23.5,
							'right': gameSettings[level]['code_reveal_right_margin'],
							'bottom': 150,
							'left': gameSettings[level]['code_reveal_left_margin']
						},
					  width = 325,
					  height = 200;

						appendGroupSVG('svg3', 'color_code_reveal', width, height, margin.left, margin.top, 'auto');

						reveal = svg3.selectAll()
									    .data(data, function(d) { return d.column+':'+d.turn; })
								    	.enter();

						reveal.append('rect')
									.filter(function(d) { return d.color_index<=colorCode.length; })
									.attr('x', function(d) { return x(d.column); })
									.attr('y', function(d) { return y(d.turn) + 33; })
									.attr('rx', 3)
						      .attr('ry', 3)
						      .attr('width', x.bandwidth())
						      .attr('height', y.bandwidth())
						      .style('fill', function(d, i) { return colorDic[colorCode[i]]; } )
									.style('stroke-width', 1)
									.style('stroke', 'black');
					}
				};
			});

		</script>
	</body>
</html>
