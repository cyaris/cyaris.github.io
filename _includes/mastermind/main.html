<!-- <!DOCTYPE html> -->
<html>
	<head>
		<style type='text/css'>

			@media (min-width:800px){
				#color_buttons {
					margin-left:13.5%;
				}
			}

			@media (max-width:800px){
        #color_buttons {
					margin-left:22.5%;
        }
	      div.tooltip {
					display: none;
	      }
	    }

			#hidden_button_win {
				display: none;
			}

			#hidden_button_lose {
				display: none;
			}

		</style>
		<script type='text/javascript'>

			boolDic = { true: 1, false: 0 },
			pieceDic = {
				1: '.',
				2: ':',
				3: ':.',
				4: '::',
				5: '★',
				'.': 1,
				':': 2,
				':.': 3,
				'::': 4,
				'★': 5
			},
			fontSizeDic = {
				'.': 25,
				':': 25,
				':.': 25,
				'::': 25,
				'★': 12.5
			},
			levelAddress = window.location.href,
			level = levelAddress.charAt(levelAddress.length-2);

			gameSettings = {
				1: {
						'code_length': 4,
						'code_length_text': 'four',
						'color_options': Array('yellow', 'blue', 'red', 'green', 'orange', 'purple'),
						'color_buttons_data': Array(1, 2, 3, 4, 5, 6),
						'max_turns': 8,
						'max_clicks': 32,
						'rect_text_loc': Array(17.5, 23.5),
						'winning_symbol': '::',
						'code_reveal_right_margin': 123,
						'button_spacer': 3,
						'game_board_height': 354
					 },
				2: {
						'code_length': 4,
						'code_length_text': 'four',
						'color_options': Array('yellow', 'blue', 'red', 'green', 'orange', 'purple', 'brown', 'pink'),
						'color_buttons_data': Array(1, 2, 3, 4, 5, 6, 7, 8),
						'max_turns': 9,
						'max_clicks': 36,
						'rect_text_loc': Array(17.5, 23.5),
						'winning_symbol': '::',
						'code_reveal_right_margin': 123,
						'button_spacer': 2.2,
						'game_board_height': 390.5
					 },
				3: {
						'code_length': 5,
						'code_length_text': 'five',
						'color_options': Array('yellow', 'blue', 'red', 'green', 'orange', 'purple'),
						'color_buttons_data': Array(1, 2, 3, 4, 5, 6),
						'max_turns': 9,
						'max_clicks': 45,
						'rect_text_loc': Array(14, 23.5),
						'winning_symbol': '★',
						'code_reveal_right_margin': 108,
						'button_spacer': 3,
						'game_board_height': 390.5
					 },
				4: {
						'code_length': 5,
						'code_length_text': 'five',
						'color_options': Array('yellow', 'blue', 'red', 'green', 'orange', 'purple', 'brown', 'pink'),
						'color_buttons_data': Array(1, 2, 3, 4, 5, 6, 7, 8),
						'max_turns': 10,
						'max_clicks': 50,
						'rect_text_loc': Array(14, 23.5),
						'winning_symbol': '★',
						'code_reveal_right_margin': 108,
						'button_spacer': 2.2,
						'game_board_height': 427
					 }
			};

			// colorCode = [];
			// for ( i=0; i < gameSettings[level]['code_length']; i++ ) {
			//   colorCode.push(gameSettings[level]['color_options'][getRandomInt(0, gameSettings[level]['color_options'].length)])
			// };
			color1 = gameSettings[level]['color_options'][getRandomInt(0, gameSettings[level]['color_options'].length)],
			color2 = gameSettings[level]['color_options'][getRandomInt(0, gameSettings[level]['color_options'].length)],
			color3 = gameSettings[level]['color_options'][getRandomInt(0, gameSettings[level]['color_options'].length)],
			color4 = gameSettings[level]['color_options'][getRandomInt(0, gameSettings[level]['color_options'].length)],
			color5 = gameSettings[level]['color_options'][getRandomInt(0, gameSettings[level]['color_options'].length)],
			colorCode = Array(color1, color2, color3, color4, color5),
			colorCode = colorCode.slice(0, gameSettings[level]['code_length']);
			console.log(colorCode);

		</script>
	</head>
	<body>
		<div class='no_selection no_events' id='level_message' align='center'></div>
		<script type='text/javascript'>

			document.getElementById('level_message').innerHTML = String(gameSettings[level]['max_turns']) + ' tries to crack the ' + gameSettings[level]['code_length_text'] + ' color code.<br>' + String(gameSettings[level]['color_options'].length) + ' possible colors.'

		</script>
		<!-- Load color palettes -->
		<script src='https://d3js.org/d3-scale-chromatic.v1.min.js'></script>
		<!-- Create a div where the graph will take place -->
		<div class='no_selection' id='game_board' align='center' style='margin-top:20px;'></div>
		<div class='no_selection' id='hidden_button_win'>
			<div id='hidden_button_win_text'>
				<span class='blinking_text'>
					<p align='center' style='margin-left:-3.5px; margin-top:-20px; margin-bottom:5px;'>
						<font size='5.5'>
							<b>You win!</b>
						</font>
					</p>
				</span>
			</div>
			<div class='center'>
				<a href='{{ site.url }}/mastermind/play/' class='btn-group'>Play Again</a>
				<br>
				<br>
				<br>
			</div>
		</div>
		<div class='no_selection' id='hidden_button_lose'>
			<div class='no_selection no_events' id='color_code_reveal' align='center'></div>
			<div id='hidden_button_lose_text'>
				<span class='blinking_text'>
					<p align='center' style='margin-left:-190px; margin-top:-220px;'>
						<font size='5.5'>
							<b>You lose!</b>
						</font>
					</p>
				</span>
				<p align='center' style='margin-left:-175px; margin-top:-30px; margin-bottom:70px;'>Here's the code:</p>
			</div>
			<div class='center'>
				<a href='{{ site.url }}/mastermind/play/' class='btn-group' style='margin-top:20px;'>Play Again</a>
				<br>
				<br>
				<br>
			</div>
		</div>
		<!-- Create a div where the color selection will take place -->
		<div id='color_buttons' align='center' style='margin-top:-40px; margin-bottom:-60px;'></div>
		<script type='text/javascript'>

			// Define colors for both svg1 and svg2
			colorDic = {
				'rgb(152, 78, 163)': 'purple',
				'rgb(77, 175, 74)': 'green',
				'rgb(55, 126, 184)': 'blue',
				'rgb(228, 26, 28)': 'red',
				'rgb(255, 255, 51)': 'yellow',
				'rgb(255, 127, 0)': 'orange',
				'rgb(166, 86, 40)': 'brown',
				'rgb(247, 129, 191)': 'pink',
				'purple': 'rgb(152, 78, 163)',
				'green': 'rgb(77, 175, 74)',
				'blue': 'rgb(55, 126, 184)',
				'red': 'rgb(228, 26, 28)',
				'yellow': 'rgb(255, 255, 51)',
				'orange': 'rgb(255, 127, 0)',
				'brown': 'rgb(166, 86, 40)',
				'pink': 'rgb(247, 129, 191)'
			};

			// set the dimensions and margins of the svg1 graph
			margin = { top: 30, right: 25, bottom: 30, left: 25 },
			width = 350,
			height = gameSettings[level]['game_board_height'];

			// Define global variables for svg1
			clickCount = 0,
			gridScoreDic = {},
			guessDic = {},
			bScores = [],
			fillDic = {
				'W': 'rgb(211,211,211)',
				'B': 'rgb(211,211,211)'
			};

			for ( i=1; i < gameSettings[level]['max_clicks']+1; i++ ) {
			  fillDic[i] = '#ffffff'
			};

			// Define global variables for svg2
			colorScale = d3.scaleOrdinal(d3['schemeSet1']),
			circ_radius = 100,
			svg2Size = circ_radius * 3,
			interval = 360/gameSettings[level]['color_options'].length;

			// append the svg objects to the body of the page
			addStdGroupSVG('svg1', 'game_board', width, height, margin.left, margin.top, 'auto');
			addStdGroupSVG('svg2', 'color_buttons', svg2Size, svg2Size, circ_radius, circ_radius, 'auto');
			defineTooltip('game_board', 'game_board_tooltip', '555px', 0, '115px', '52.5px', 0, '')

			d3.csv('/assets/csv/mastermind/game_board_' + String(level) + '.csv', function(data) {
				// Build X and Y scales and axis:
				x = d3.scaleBand()
							.range([0, width - margin.left - margin.right])
							.domain(d3.map(data, function(d){ return d.group; }).keys())
							.padding(0.05),
				y = d3.scaleBand()
							.range([0, height - margin.top - margin.bottom])
							.domain(d3.map(data, function(d){ return d.variable; }).keys())
							.padding(0.05);

				svg1.append('g')
						.attr('pointer-events', 'none')
						.style('font-size', 14.5)
						.call(d3.axisTop(x).tickSize(0))
							.select('.domain').remove();

				svg1.append('g')
						.attr('pointer-events', 'none')
						.style('font-size', 14.5)
						.call(d3.axisLeft(y).tickSize(0))
							.select('.domain').remove();

				// Three function that change the tooltip when user hover / move / leave a cell
 				var graphMouseover = function(d) {
 						if ( d.group=='W' || d.group=='B' ) {

 							d3.select('#game_board_tooltip').style('opacity', 1);

 							d3.select(this)
 								.style('stroke-width', 3)
 								.style('stroke', 'black')
 								.style('opacity', 1)
 								.style('cursor', 'help');

 							if ( gridScoreDic[d.score_index]==null )
 							{ toolNumber = 0; }
 							else
 							{ toolNumber = pieceDic[gridScoreDic[d.score_index]]; }

 							if ( d.group=='W' )
 							{ colorState = ' wrong'; }
 							else
 							{ colorState = ' right'; }

 							if ( toolNumber==1 )
 							{ cPlur = ''; }
 							else
 							{ cPlur = 's'; }

 							if ( toolNumber!=0 )
 							{ d3.select('#game_board_tooltip').html(toolNumber + ' right color' + cPlur + ' in<br>the ' + colorState + ' place.'); }
 							else if ( toolNumber==0 && (d.variable)<=(clickCount/gameSettings[level]['code_length']) )
 							{ d3.select('#game_board_tooltip').html('No right color' + cPlur + ' in' + '<br>the ' + colorState + ' place.'); }
 							else
 							{ d3.select('#game_board_tooltip').html('This round hasn\'t<br>been played yet.'); }

 							d3.select('#game_board_tooltip').style('top', (d3.mouse(this)[1]) + 76.5 + 'px')
 					 	}
 			 	},
 						graphMouseleave = function(d) {
 						if ( d.group=='W' || d.group=='B' ) {
 								d3.select('#game_board_tooltip').style('opacity', 0);
 								d3.select(this)
 									.style('stroke-width', 1)
 									.style('stroke', 'black')
 									.style('opacity', 1);
 						}
 				};

			  rect = svg1.selectAll()
			    .data(data, function(d) { return d.group+':'+d.variable; })
			    .enter();

				rect.append('rect')
						.attr('id', 'rect_colors')
						.attr('x', function(d) { return x(d.group); })
			      .attr('y', function(d) { return y(d.variable); })
			      .attr('rx', 3)
			      .attr('ry', 3)
			      .attr('width', x.bandwidth())
			      .attr('height', y.bandwidth())
			      .style('fill', function(d) { return fillDic[d.color_index]; })
						.attr('stroke-width', 1)
						.style('stroke', 'black')
				    .on('mouseover', graphMouseover)
				    .on('mouseleave', graphMouseleave);

				var buttonMouseover = function(d) {

						d3.select(this)
							.style('stroke-width', 4)
							.style('stroke', 'black')
							.style('opacity', 1)
							.style('cursor', 'pointer');
 				},
 						buttonMouseleave = function(d) {

						d3.select(this).style('stroke-width', 2);
 				};

				svg2.selectAll('circle')
			    .data(gameSettings[level]['color_buttons_data'])
			    .enter()
					.append('circle')
						.attr('id', 'color_buttons')
				    .attr('fill', function(d, i ) { return colorScale(d); })
				    .attr('r', (svg2Size*gameSettings[level]['button_spacer'])/interval)
				    .attr('transform', function (d, i) {
				        return 'translate(' + ((svg2Size/2-circ_radius) * Math.cos((interval*i)
								* Math.PI/180)) + ',' + ((svg2Size/2-circ_radius) * Math.sin((interval*i)
								* Math.PI/180)) + ')'}
							)
						.style('stroke-width', 2)
						.style('stroke', 'black')
						.style('opacity', 1)
			    .on('mouseover', buttonMouseover)
			    .on('mouseleave', buttonMouseleave)
					.on('click', function() {
		          clickCount+=1;
							fillDic[clickCount] = d3.select(this).style('fill');
							guessDic[clickCount] = colorDic[d3.select(this).style('fill')];
							updateBoard();
						});

				addStdText(svg2, 'cursive', null, -21.5, -5, '17px', 'normal', 1, 0.5, 'Choose');
				addStdText(svg2, 'cursive', null, -23, 16.5, '17px', 'normal', 1, 0.5, 'a Color');

				updateBoard = function() {

					svg1.selectAll('#rect_colors')
						.style('fill', function(d) { return fillDic[d.color_index]; })
						.style('stroke-width', 1);

					svg1.selectAll('#rect_colors')
						.filter(function(d) { return d.color_index==clickCount+1; })
						.style('stroke-width', 3);

					if ( clickCount%gameSettings[level]['code_length']==0 ) {

						svg1.selectAll('#rect_text').remove();

						rect.append('text')
								.filter(function(d) { return d.group=='W' || d.group=='B'; })
								.text(function(d) {
									if ( d.group=='W' && gameSettings[level]['code_length']==4 ) {

										colorCodeCopy = Array(color1, color2, color3, color4),
										dCount = 0,
										wCount = 0,
										guessColors = Array(
											guessDic[(d.variable*4)-3],
											guessDic[(d.variable*4)-2],
											guessDic[(d.variable*4)-1],
											guessDic[d.variable*4]
										);

										for ( i = 0; i < 4; i++ ) {
											if ( guessColors[i-dCount]==colorCode[i] ) {
												delete guessColors[i-dCount];
												delete colorCodeCopy[i-dCount];
												guessColors = guessColors.filter(Boolean);
												colorCodeCopy = colorCodeCopy.filter(Boolean);
												dCount+=1;
											}
										};

										while ( guessColors.length > 0 ) {
											if ( colorCodeCopy.includes(guessColors[0]) ) {
												wCount+=1,
											  dIndex = colorCodeCopy.indexOf(guessColors[0]);
												delete guessColors[0];
												delete colorCodeCopy[dIndex];
												guessColors = guessColors.filter(Boolean);
												colorCodeCopy = colorCodeCopy.filter(Boolean);
											}
											else {
												delete guessColors[0];
												guessColors = guessColors.filter(Boolean);
											}
											gridScoreDic[d.score_index] = pieceDic[wCount]
									};
										return gridScoreDic[d.score_index]
								}
								else if ( d.group=='W' && gameSettings[level]['code_length']==5 ) {

									colorCodeCopy = Array(color1, color2, color3, color4),
									dCount = 0,
									wCount = 0,
									guessColors = Array(
										guessDic[(d.variable*5)-4],
										guessDic[(d.variable*5)-3],
										guessDic[(d.variable*5)-2],
										guessDic[(d.variable*5)-1],
										guessDic[d.variable*5]);

									for ( i = 0; i < 5; i++ ) {
										if ( guessColors[i-dCount]==colorCode[i] ) {
											delete guessColors[i-dCount];
											delete colorCodeCopy[i-dCount];
											guessColors = guessColors.filter(Boolean);
											colorCodeCopy = colorCodeCopy.filter(Boolean);
											dCount+=1;
										}
									};

									while ( guessColors.length > 0 ) {
										if ( colorCodeCopy.includes(guessColors[0]) ) {
											wCount+=1,
											dIndex = colorCodeCopy.indexOf(guessColors[0]);
											delete guessColors[0];
											delete colorCodeCopy[dIndex];
											guessColors = guessColors.filter(Boolean);
											colorCodeCopy = colorCodeCopy.filter(Boolean);
										}
										else {
											delete guessColors[0];
											guessColors = guessColors.filter(Boolean);
										}
										gridScoreDic[d.score_index] = pieceDic[wCount];
									};
									return gridScoreDic[d.score_index]
								}
								else if ( d.group=='B' && gameSettings[level]['code_length']==4 ) {
									gridScoreDic[d.score_index] = pieceDic[
									boolDic[guessDic[(d.variable*4)-3]==colorCode[0]] +
									boolDic[guessDic[(d.variable*4)-2]==colorCode[1]] +
									boolDic[guessDic[(d.variable*4)-1]==colorCode[2]] +
									boolDic[guessDic[(d.variable*4)]==colorCode[3]]];
									if ( String(gridScoreDic[d.score_index]) != 'undefined')
									{ bScores[d.variable] = gridScoreDic[d.score_index]; }

									return gridScoreDic[d.score_index];
								}
								else if ( d.group=='B' && gameSettings[level]['code_length']==5 ) {
									gridScoreDic[d.score_index] = pieceDic[
									boolDic[guessDic[(d.variable*5)-4]==colorCode[0]] +
									boolDic[guessDic[(d.variable*5)-3]==colorCode[1]] +
									boolDic[guessDic[(d.variable*5)-2]==colorCode[2]] +
									boolDic[guessDic[(d.variable*5)-1]==colorCode[3]] +
									boolDic[guessDic[(d.variable*5)]==colorCode[4]]];

									if ( String(gridScoreDic[d.score_index]) != 'undefined')
									{ bScores[d.variable] = gridScoreDic[d.score_index]; }

									return gridScoreDic[d.score_index];
								}
								// else
								// { return gridScoreDic[d.score_index]; }
							})
							.attr('id', 'rect_text')
							.attr('x', function(d) { return x(d.group) + gameSettings[level]['rect_text_loc'][0] })
							.attr('y', function(d) { if (gridScoreDic[d.score_index]=='★')
																			 { return y(d.variable) + gameSettings[level]['rect_text_loc'][1] - 2; }
																			 else
																			 { return y(d.variable) + gameSettings[level]['rect_text_loc'][1]; }})
							.style('font-size', function(d) { return fontSizeDic[gridScoreDic[d.score_index]]; })
							.style('stroke-width', 1.5)
							.style('stroke', 'black');

						if ( bScores[bScores.length-1]==gameSettings[level]['winning_symbol'] ) {
							document.getElementById('color_buttons').style.display = 'none';
							document.getElementById('hidden_button_win').style.display = 'block';
						}
						else if ( bScores[bScores.length-1]!=gameSettings[level]['winning_symbol'] && clickCount==gameSettings[level]['max_clicks'] ) {

							document.getElementById('color_buttons').style.display = 'none';
							document.getElementById('hidden_button_lose').style.display = 'block';

							// set the dimensions and margins of the graph
							margin = {
								top: 23.5,
								right: gameSettings[level]['code_reveal_right_margin'],
								bottom: 150,
								left: 25
							},
						  width = 350,
						  height = 200;

							addStdGroupSVG('svg3', 'color_code_reveal', width, height, margin.left, margin.top, 'auto');

							reveal = svg3.selectAll()
										    .data(data, function(d) { return d.group+':'+d.variable; })
									    	.enter();

							reveal.append('rect')
										.filter(function(d) { return d.color_index<=gameSettings[level]['code_length']; })
										.attr('x', function(d) { return x(d.group); })
										.attr('y', function(d) { return y(d.variable) + 33; })
										.attr('rx', 3)
							      .attr('ry', 3)
							      .attr('width', x.bandwidth())
							      .attr('height', y.bandwidth())
							      .style('fill', function(d) {
											colorFill = colorDic[colorCode[0]];
											delete colorCode[0];
											colorCode = colorCode.filter(Boolean);
											return colorFill;
										})
										.style('stroke-width', 1)
										.style('stroke', 'black');
						}
					};
				};
			});

		</script>
	</body>
</html>
