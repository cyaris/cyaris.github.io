<!-- <!DOCTYPE html> -->
<html>
	<head>
		<title>US Gun Violence Forecasting</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<style>

		/* svg {
 			border: 1px solid #000;
 		} */

		@media (max-width:750px){
	      #las_vegas_button {
						display: none;
	      }
				#line_graph {
						display: none;
	      }
				#data_credit {
						display: none;
	      }
	  }

	  @media (min-width:750px){
			#hidden_line_graph_explained {
				display: none;
	    }
	  }

		.line {
		  fill: none;
		  stroke-width: 3px;
		}

		svg text {
			-webkit-touch-callout: none;
			-webkit-user-select: none;
			-moz-user-select: none;
			-ms-user-select: none;
			user-select: none;
			pointer-events: none;
		}

		div.tooltip {
		  /* position: absolute; */
		  text-align: left;
		  padding: 10px;
			font-family: 'Lora', 'Times New Roman', serif;
			font-size: 12px;
			stroke: black;
		  background: white;
		  border: solid;
			border-width: 1px;
		  border-radius: 5px;

			-webkit-touch-callout: none;
			-webkit-user-select: none;
			-moz-user-select: none;
			-ms-user-select: none;
			user-select: none;
			pointer-events: none;
		}

		#lvTooltip {
			width: 265px;
			height: 120px;
		}

		#xAxisTooltip {
			width: 147.5px;
			height: 52.5px;
		}

		#yAxisTooltip {
			width: 162.5px;
			height: 55px;
		}

		</style>
	</head>
	<body>
		<!-- Load d3.js -->
		<script src="https://d3js.org/d3.v4.min.js"></script>
		<!-- <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script> -->
		<div id="hidden_line_graph_explained" align="left"  style="margin-bottom:20px;">
			<p>While I'm flattered you came to check out my project, it has several interactive features that work best on desktop. So, grab a computer and come back soon!</p>
		</div>
		<div id="las_vegas_button" align="left" style="margin-top:75; margin-bottom:-31.5px;"></div>
		<div id="line_graph_instructions" align="right" style="margin-bottom:7.5px;"></div>
		<!-- Create a div where the graph will take place -->
		<div id="line_graph" align="center"></div>
		<div id="data_credit" align="left"  style="margin-bottom:40px;">
			<p>All data provided by <a href="https://gunviolencearchive.org" target="_blank">Gun Violence Archive (GVA)</a>, a not for profit corporation formed in 2013 to provide online public access to accurate information about gun-related violence in the United States.</p>
		</div>
		<script>
			// set the dimensions and margins of the graph
			var margin = {top: 20, right: 20, bottom: 65, left: 65},
			    width = 750 - margin.left - margin.right,
			    height = 450 - margin.top - margin.bottom,
					// and for the las vegas svg
					lvWidth = 200,
					lvHeight = 40,
					// set the dimensions of the margin rects
					marginRectDic = {
								0: {"x": margin.left * -1, "y": 0,
								"width": margin.left, "height": height},
								1: {"x": width, "y": 0,
								"width": margin.right, "height": height},
								2: {"x": margin.left * -1, "y": margin.top * -1,
								"width": width + margin.left + margin.right, "height": margin.top},
								3: {"x": margin.left * -1, "y": height,
								"width": width + margin.left + margin.right, "height": margin.bottom},
							},
					marginRectDicKeys = Object.keys(marginRectDic);
			// append the svg object to the body of the page
			var svg1 = d3.select("#line_graph")
					.append("svg")
					  .attr("width", width + margin.left + margin.right)
					  .attr("height", height + margin.top + margin.bottom)
					.append("g")
					  .attr("transform",
					        "translate(" + margin.left + "," + margin.top + ")");

			svg1.append("rect")
						.attr("pointer-events", "none")
						.attr("x", ((margin.left/2) * -1)-5.5)
						.attr("y", (margin.top * -1)+.5)
						.attr("width", width + (margin.left/2) + margin.right + 5)
						.attr("height", height + margin.top + (margin.bottom/2))
						.style("fill", "transparent")
						.style("stroke", "black");
			// Add label for x axis
		  svg1.append("text")
					.attr("pointer-events", "none")
		      .attr("transform", "translate(" +
					(width/2) + " ," +
					(height + margin.top + 37.5) + ")")
					.attr("x", -32.5)
		      .text("Date")
						.style("font-size", "18px")
						.style("stroke-width", 1.5);
		  // Add label for y axis
		  svg1.append("text")
					.attr("pointer-events", "none")
		      .attr("transform", "rotate(-90)")
		      .attr("x", 0-(height/2))
		      .attr("y", 15-margin.left)
		      .text("Total Killed or Injured")
						.style("font-size", "18px")
						.style("stroke-width", 1.5)
						.style("text-anchor", "middle")
			// parse the date / time
			var parseTime = d3.timeParse("%Y-%m-%d"),
					// set the ranges
					x = d3.scaleTime().range([0, width]),
					y = d3.scaleLinear().range([height, 0]);

			var addStdText = function(svgInput, idInput, textX, textY, fontSize, strokeWidth, fontStyle, textInput) {

			 svgInput.append("text")
					.attr("pointer-events", "none")
					.attr("id", idInput)
					.attr("x", textX)
					.attr("y", textY)
					.text(textInput)
						.style("fill", "black")
						.style("font-size", fontSize)
						.style("font-style", fontStyle)
						.style('stroke-width', strokeWidth)
						.style('stroke', function(d) {
							if ( strokeWidth==0 )
							{ return "transparent" }
							else
							 { return "black" }
						 });
			};
			// adding svg3 here so it becomes a global variable that can be accessed by svg1
			var svg3 = d3.select("#line_graph_instructions")
					.append("svg")
						.attr("width", 263.5)
						.attr("height", 25);

			addStdText(svg3, "hover_instruction", 0, 17.5, "13.5px", 0.5, "normal", "Hover to Compare Historical Forecasts");

			var addTooltipSymbol = function(svgInput, circX, circY, textX, textY, textRotate) {

				svgInput.append("circle")
							.attr("pointer-events", "none")
							.attr("cx", circX)
							.attr("cy", circY)
		 			    .attr('fill', "rgb(0,122,255)")
							.attr('opacity', 0.9)
		 			    .attr('r', 7.5);

				svgInput.append("text")
							.attr("pointer-events", "none")
							.attr("transform", textRotate)
							.attr("x", textX)
							.attr("y", textY)
							.text("i")
								.style('stroke', "white")
								.style('fill', "white")
								.style('font-size', "11.5px")
								.style('font-weight', 500);
			};

			function getTextWidth(svgInput, textInput, fontSize) {

				var textWidthArray = [];

				svgInput.append('g')
						    .selectAll('.dummyText')
						    .data([textInput])
						    .enter()
						    .append("text")
							    .attr("font-size", String(fontSize) + "px")
							    .text(function(d) { return d; })
							    .each(function(d,i) {
							        var thisWidth = this.getComputedTextLength();
							        textWidthArray.push(thisWidth);
							        this.remove();
				    });
				{ var textWidth = textWidthArray.reduce((a, b) => a + b, 0);
					return textWidth; }
				};

			d3.csv("../assets/us_harmed_victim_forecast_data.csv", function(data) {

				var numRows = data.length,
						minYear = d3.min(data, function(d) { return d.year }),
						maxYear = d3.max(data, function(d) { return d.year }),
						numYears = maxYear - minYear,
						obsMaxYear = [],
						allDates = [],
						allObs = [],
						nydDic = {},
						yearIndex = [],
						allYears = [],
						obsPerYearDic = {},
						daysCumDic = {},
						obsCumDic = {},
						numObsCumCount = 0,
						incidentCumDic = {};
				// format the data
				data.forEach(function(d) {
						d.date = parseTime(d.date);
						d.index = +d.index;
						if ( d.nyd!=null && d.nyd!='' ) {
							nydDic[d.nyd] = d.index
						};
						d.num_harmed = +d.num_harmed;
						allObs.push(d.num_harmed);
						allDates.push(d.date);
						d.year = +d.year;
						d.non_observation = +d.non_observation;
						d.num_incidents = +d.num_incidents;
				});

				for (var i = 1; i <= numYears; i++) {
						yearIndex.push(Number(i));
				};

				for ( var i = minYear; i <= maxYear; i++ ) {
						allYears.push(Number(i));
						numDaysYearCount = 0;
						numDaysCumCount = 0;
						numIncidentCumCount = 0;
						data.forEach(function(d) {
							numDaysCumCount+=1;
							numIncidentCumCount+=d.num_incidents;
							if ( d.year==i )
							{ numDaysYearCount+=1;
								daysCumDic[i] = numDaysCumCount;
								incidentCumDic[i] = numIncidentCumCount; }
							if ( d.year==i && d.non_observation!=1 )
							{ obsMaxYear.push(Number(i));
								numObsCumCount+=1; }
						});
						obsPerYearDic[i] = numDaysYearCount;
						obsCumDic[i] = numObsCumCount;
				};

				var nydKeys = Object.keys(nydDic),
						obsMaxYear = d3.max(obsMaxYear),
						allObs = allObs.sort(function(a,b){return b-a}),
						maxOb = d3.max(allObs),
						// set initial yMax which will be changed as scale is adjusted
						yMax = maxOb,
						maxDiff = allObs[0]-allObs[1],
						minDate = d3.min(allDates);

			var createSVG2 = function() {

				var lvTooltip = d3.select("#las_vegas_button")
											 .append("div")
												 .attr("class", "tooltip")
												 .attr("id", "lvTooltip")
												 .style("left", "220px")
												 .style("top", "-75px")
												 .html("The Las Vegas shooting is the deadliest mass shooting committed by an individual in US history. With 548 total victims killed/injured, it is a major outlier in this dataset. See how removing this observation effects the distribution of the entire graph.");

				var lvMouseover = function(d) {
							lvTooltip
								.style("opacity", 1);
							updateGraph(yMax, "rgb(255,59,48)", obsMaxYear, "yes");
				},
						lvMouseleave = function(d) {
							lvTooltip
								.style("opacity", 0);
							updateGraph(yMax, "rgb(255,59,48)", obsMaxYear, "no");
				},
						checkMarkHover = function(d) {
							d3.select(this)
								.style("stroke", "black")
								.style("stroke-width", 2)
								.style("cursor", "pointer");
				},
						checkMarkLeave = function(d) {
							d3.select(this)
								.style("stroke", "black")
								.style("stroke-width", 1);
				};
				// append the svg object to the body of the page
				var svg2 = d3.select("#las_vegas_button")
						.append("svg")
						  .attr("width", lvWidth)
						  .attr("height", lvHeight)
							.on("mouseover", lvMouseover)
							.on("mouseleave", lvMouseleave);

				svg2.append("rect")
						.attr("x", 27)
						.attr("y", 9)
						.attr("width", lvWidth/7.75)
						.attr("height", lvHeight/1.65)
						.style("cursor", "pointer")
						.style("fill", "transparent")
						.style("stroke", "black")
						.style("stroke-width", 1)
					.on("mouseover", checkMarkHover)
					.on("mouseleave", checkMarkLeave)
					.on("click", function() {
						if (yMax==maxOb)
						{ yMax = allObs[1];
							createRect(yMax);
							updateGraph(yMax, "rgb(255,59,48)", obsMaxYear, "no");
							d3.select("#checkMark").remove();
					}
						else
						{ yMax = maxOb;
							createRect(yMax);
							updateGraph(yMax, "rgb(255,59,48)", obsMaxYear, "yes");
							addStdText(svg2, "checkMark", 32, 28, "20px", 0, "✓");
						}
					});

					addStdText(svg2, null, 60, 17.5, "12px", 0, "normal",  "Scaled with");

					addStdText(svg2, null, 60, 32.5, "12px", 0, "normal", "Las Vegas Shooting");

					addTooltipSymbol(svg2, lvWidth-16.5, 28.5, lvWidth-18, 32, "rotate(0)");

					addStdText(svg2, "checkMark", 32, 28, "20px", 0, "normal", "✓");
			};

			var createGraph = function() {

				d3.csv("../assets/us_harmed_victim_forecast_data.csv", function(data) {
					// format the data
					data.forEach(function(d) {
							d.date = parseTime(d.date);
							d.num_harmed = +d.num_harmed;
							d.trend = +d.trend;
							d.year = +d.year;
							d.non_observation = +d.non_observation;
					});
					// Scale the range of the data
					x.domain(d3.extent(data, function(d) { return d.date; }));
					y.domain([0, d3.max(data, function(d) { return d.num_harmed + 25; })]);
					// Add the circles.
					svg1.selectAll("circle")
							.data(data)
							.enter()
							.append("circle")
								.attr("pointer-events", "none")
								.attr("id", "circle_obs")
								.attr("r", 2)
								.attr("cx", function(d) { return x(d.date); })
								.attr("cy", function(d) { return y(d.num_harmed); })
								.style("fill", function(d) {
									if ( d.non_observation==1 )
									{ return 'transparent' }
									else
									{ return 'white' }
								})
								.style("stroke", function(d) {
									if ( d.non_observation==1 )
									{ return 'transparent' }
									else
									{ return 'black' }
								});
					// define the line
					var valueLine = d3.line()
							.x(function(d) { return x(d.date); })
							.y(function(d) { return y(d.trend); });
					// Add the valueline path.
					svg1.append("path")
							.data([data])
							.attr("pointer-events", "none")
							.attr("class", "line")
							.attr("d", valueLine)
							.style("stroke", "rgb(255,59,48)")
							.style("stroke-width", 3);

					// Add observation timeframe label
					addStdText(svg1, null, width-152, 0, "12px", 0, "normal", "Model Based on Data From:");

					addStdText(svg1, "obs_text", width-74.5, 15, "12px", 0, "normal", String(allYears[0]) + "–Present");

					var textInput = daysCumDic[obsMaxYear].toLocaleString() + " Total Days",
							textWidthOut = getTextWidth(svg1, textInput, 12);

					addStdText(svg1, "obs_text", width - textWidthOut, 30, "12px", 0, "normal", textInput);

					var textInput = incidentCumDic[obsMaxYear].toLocaleString() + " Total Incidents",
							textWidthOut = getTextWidth(svg1, textInput, 12);

					addStdText(svg1, "obs_text", width - textWidthOut, 45, "12px", 0, "normal", textInput);
					// Add the X Axis
				  svg1.append("g")
							.attr("pointer-events", "none")
							.attr("id", "x axis")
				      .attr("transform", "translate(0," + height + ")")
							.style("font-size", "12px")
				      .call(d3.axisBottom(x));
				  // Add the Y Axis
				  svg1.append("g")
							.attr("pointer-events", "none")
							.attr("class", "y axis")
							.style("font-size", "12px")
				      .call(d3.axisLeft(y));
				});
		};

			var updateGraph = function(maximumY, trendColor, hoverYear, highlightMax) {
				d3.csv("../assets/us_harmed_victim_forecast_data.csv", function(data) {
					// format the data
					data.forEach(function(d) {
							d.date = parseTime(d.date);
							d.num_harmed = +d.num_harmed;
							d.trend = +d.trend;
							d.year = +d.year;
							d.non_observation = +d.non_observation;
					});
					// Rescale the range of the data vertically
					y.domain([0, maximumY + 25]);
					// Update the circles.
					svg1.selectAll("#circle_obs")
							.attr("cy", function(d) { return y(d.num_harmed); })
							.style("fill", function(d) {
								if ( d.non_observation==1 || d.year > hoverYear )
								{ return 'transparent' }
								else
								{ return 'white' }
							})
							.style("stroke", function(d) {
								if ( d.non_observation==1 || d.year > hoverYear )
								{ return 'transparent' }
								else
								{ return 'black' };})
							.style("stroke-width", function(d) {
								if ( highlightMax=="yes" )
									{ if ( d.num_harmed==maxOb )
										{ return 5; }
										else
										{ return 1; }}
								else
								{ return 1; }
							});
					// Re-define the line
					var valueLine = d3.line()
							.x(function(d) { return x(d.date); })
							.y(function(d) { return y(d.trend); });
					// Add the valueline path.
					svg1.select("path")
							.attr("d", valueLine)
							.style("stroke", trendColor);
					// Remove observation year label and replace with new one
					d3.selectAll("#obs_text").remove();

					svg1.append("text")
							.attr("pointer-events", "none")
							.attr("id", "obs_text")
							.attr("x", function(d) {
								if ( hoverYear>=obsMaxYear )
								{ return width-74.5; }
								else if ( hoverYear==minYear )
								{ return width-25; }
								else
								{ return width-56; }
							})
							.attr("y", 15)
							.text(function(d) {
								if ( hoverYear>=obsMaxYear )
								{ return String(allYears[0]) + "–Present" }
								else if ( hoverYear==minYear )
								{ return String(allYears[0]); }
								else
								{ return String(allYears[0]) + "–" + String(hoverYear); }
							})
								.style("font-size", "12px")
								.style("fill", "black");

					var textInput = daysCumDic[hoverYear].toLocaleString() + " Total Days",
							textWidthOut = getTextWidth(svg1, textInput, 12);

					addStdText(svg1, "obs_text", width - textWidthOut, 30, "12px", 0, "normal", textInput);

					var textInput = incidentCumDic[hoverYear].toLocaleString() + " Total Incidents",
							textWidthOut = getTextWidth(svg1, textInput, 12);

					addStdText(svg1, "obs_text", width - textWidthOut, 45, "12px", 0, "normal", textInput);
					// Update the Y Axis
					svg1.select(".y")
				      .call(d3.axisLeft(y));
				});
		};

			var createRect = function(maximumY) {
				d3.csv("../assets/us_harmed_victim_forecast_data.csv", function(data) {
					// Format the data
					data.forEach(function(d) {
							d.date = parseTime(d.date);
							d.num_harmed = +d.num_harmed;
					});
					// Scale the range of the data
					x.domain(d3.extent(data, function(d) { return d.date; }));
					y.domain([0, maximumY + 25]);

					var yearMouseover = function(d) {

						svg1.append("rect")
								.attr("pointer-events", "none")
								.attr("id", "highlight_rect")
								.attr("x", 0)
								.attr("y", 0)
								.attr("width", function() {
									if ( allYears[Number(d)] < obsMaxYear )
									{ return (width/numRows)*obsCumDic[allYears[Number(d)]]; }
									else
									{ return 0; }
								})
								.attr("height", height)
								.style("fill", "transparent")
								.style("stroke-width", 1)
								.style("stroke", "black");

							if (allYears[Number(d)] < obsMaxYear)
							{ d3.selectAll("#hover_instruction").remove();
								addStdText(svg3, "hover_instruction", 41, 17.5, "13.5px", 0.5, "italic", "Comparing Historical Forecasts...");
								updateGraph(yMax, "grey", allYears[Number(d)], "no"); }
							else
							{ d3.selectAll("#hover_instruction").remove();
								addStdText(svg3, "hover_instruction", 0, 17.5, "13.5px", 0.5, "normal", "Hover to Compare Historical Forecasts");
								updateGraph(yMax, "rgb(255,59,48)", obsMaxYear, "no"); };
					},
							yearMouseleave = function(d) {
								d3.select("#highlight_rect").remove();
								d3.selectAll("#hover_instruction").remove();
								addStdText(svg3, "hover_instruction", 0, 17.5, "13.5px", 0.5, "normal", "Hover to Compare Historical Forecasts");
					},
							marginMouseover = function(d) {
								updateGraph(yMax, "rgb(255,59,48)", obsMaxYear, "no");
					};
					// Add the year rect boundaries
					var yearRect = svg1.selectAll()
							.data(nydKeys, function(d) { return d; })
							.enter();
					// Add the year rectangles
					yearRect.append("rect")
								.attr("x", function(d) { return x(allDates[nydDic[d]]); })
								.attr("y", 0)
								.attr("width", function(d) { return (width/numRows)*obsPerYearDic[allYears[Number(d)]]; } )
								.attr("height", height)
								.style("fill", "transparent")
								.style("stroke", "transparent")
								.on("mouseover", yearMouseover)
								.on("mouseleave", yearMouseleave);
					// Add the margin rect boundaries
					var marginRect = svg1.selectAll()
							.data(marginRectDicKeys, function(d) { return d; })
							.enter();
					// Add the margin rectangles
					marginRect.append("rect")
							.attr("x", function(d) { return marginRectDic[d]["x"]; })
							.attr("y", function(d) { return marginRectDic[d]["y"]; })
							.attr("width", function(d) { return marginRectDic[d]["width"]; })
							.attr("height", function(d) { return marginRectDic[d]["height"]; })
							.style("fill", 'transparent')
							.style("stroke", "transparent")
							.on("mouseover", marginMouseover);

					var xAxisTooltip = d3.select("#line_graph")
												 .append("div")
													 .attr("class", "tooltip")
													 .attr("id", "xAxisTooltip")
													 .style("left", "455px")
													 .style("top", "465px")
													 .style("bottom", "0px")
													 .html("Incidents are grouped by date across the US."),
							xAxMouseover = function(d) {
								xAxisTooltip
									.style("opacity", 1);
					},
							xAxMouseleave = function(d) {
								xAxisTooltip
									.style("opacity", 0);
					};

					svg1.append("rect")
								.attr("x", (width/2)-40)
								.attr("y", height + margin.top + 21)
								.attr("width", 70)
								.attr("height", 20)
								.style("fill", "transparent")
								.style("stroke", "transparent")
								.on("mouseover", xAxMouseover)
								.on("mouseleave", xAxMouseleave);

					addTooltipSymbol(svg1, (width/2) + 21, height + margin.top + 32,
					(width/2) + 19.5, height + margin.top + 35.5, "rotate(0)");

					var yAxisTooltip = d3.select("#line_graph")
												 .append("div")
													 .attr("class", "tooltip")
													 .attr("id", "yAxisTooltip")
													 .style("left", "15px")
													 .style("top", "70px")
													 .style("bottom", "0px")
													 .html("Victims with unreported injuries are not included."),
							yAxMouseover = function(d) {
								yAxisTooltip
									.style("opacity", 1);
					},
							yAxMouseleave = function(d) {
								yAxisTooltip
									.style("opacity", 0);
					};

					svg1.append("rect")
								.attr("x", -65)
								.attr("y", (height/2)-115)
								.attr("width", 22.5)
								.attr("height", 210)
								.style("fill", "transparent")
								.style("stroke", "transparent")
								.on("mouseover", yAxMouseover)
								.on("mouseleave", yAxMouseleave);

					addTooltipSymbol(svg1, -54, (height/2)-106.5, -77.5, -50, "rotate(-90)");
				});
			};

			createSVG2();
			createGraph();
			createRect(yMax);

		});

		</script>
	</body>
</html>
